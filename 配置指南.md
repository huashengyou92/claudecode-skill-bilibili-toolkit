# Bilibili 工具包配置指南

## 安装步骤

### 第一步：安装 Python 依赖

```bash
cd .claude/skills/bilibili-toolkit
pip install -r requirements.txt
```

需要安装的包：
- `requests` - 用于向 B 站 API 发送 HTTP 请求
- `urllib3` - URL 处理工具

### 第二步：配置 B 站 Cookie

B 站需要登录认证才能访问字幕。你需要提供你的 B 站 Cookie。

#### 方案 A：创建配置文件（推荐）

1. 创建工作区目录（如果不存在）：
   ```bash
   mkdir -p ../../../../bilibili-workspace
   ```

2. 复制模板文件：
   ```bash
   cp bilibili_cookies.json.template ../../../../bilibili-workspace/bilibili_cookies.json
   ```

3. 获取你的 B 站 Cookie：

   **方法 1：使用浏览器开发者工具**

   1. 在浏览器中登录 bilibili.com
   2. 打开开发者工具（按 F12）
   3. 转到「应用程序/Application」>「存储/Storage」>「Cookie」> https://www.bilibili.com
   4. 找到并复制以下三个值：
      - `SESSDATA`
      - `bili_jct`
      - `buvid3`

   **方法 2：使用自动化脚本**

   ```bash
   cd scripts
   python setup_cookies.py
   ```

   按照提示粘贴你的 Cookie 字符串。

4. 编辑 `bilibili-workspace/bilibili_cookies.json`：
   ```json
   {
     "SESSDATA": "你的_sessdata_值",
     "bili_jct": "你的_bili_jct_值",
     "buvid3": "你的_buvid3_值"
   }
   ```

#### 方案 B：使用环境变量

设置以下环境变量：

```bash
export BILIBILI_SESSDATA="你的_sessdata"
export BILIBILI_BILI_JCT="你的_bili_jct"
export BILIBILI_BUVID3="你的_buvid3"
```

Windows 用户：
```cmd
set BILIBILI_SESSDATA=你的_sessdata
set BILIBILI_BILI_JCT=你的_bili_jct
set BILIBILI_BUVID3=你的_buvid3
```

## 目录结构说明

本技能遵循 Claude Skills 官方标准，实现了关注点分离：

```
.claude/skills/bilibili-toolkit/     # 技能定义目录
├── SKILL.md                         # 技能功能描述
├── 配置指南.md                       # 本文件
├── README.md                        # 用户手册
├── requirements.txt                 # Python 依赖列表
├── bilibili_cookies.json.template   # Cookie 配置模板
├── scripts/                         # 实现脚本
│   ├── workflow.py                  # 主工作流脚本
│   ├── bilibili_search.py          # 搜索功能
│   ├── bilibili_downloader.py      # 下载和字幕提取
│   ├── wbi_signer.py               # 2025 WBI 签名机制
│   ├── batch_processor.py          # 批处理工具
│   └── setup_cookies.py            # Cookie 配置助手
└── test_skill.py                    # 技能测试脚本

bilibili-workspace/                  # 输出数据目录（与技能分离）
├── bilibili_cookies.json           # 你的 Cookie 配置（用户数据）
├── subtitles/                      # 下载的字幕文件
├── reports/                        # 分析报告
├── articles/                       # 生成的文章
└── downloads/                      # 下载的视频数据
```

### 为什么要分离？

- **技能目录**：只包含代码和模板，可以安全地升级
- **工作区目录**：包含你的数据和配置，升级不会影响
- **好处**：更新技能时不会丢失你的数据

## 测试配置

### 快速测试

运行测试脚本验证一切正常：

```bash
cd .claude/skills/bilibili-toolkit
python test_skill.py
```

### 手动测试

测试字幕下载功能：

```bash
cd scripts
python workflow.py "测试关键词" --max-videos 2
```

这会：
1. 搜索 B 站上的相关视频
2. 选择播放量最高的 2 个视频
3. 下载它们的字幕
4. 保存到 `bilibili-workspace/subtitles/`

## 使用方法

配置完成后，你可以直接通过 Claude Code 使用技能：

### 自然语言使用

直接用中文向 Claude 提问，技能会自动激活：

- "搜索 B 站上关于 Python 的视频"
- "帮我下载这个 B 站视频的字幕：BV1234567890"
- "分析一下 B 站上关于 AI 的讨论"

Claude 会自动：
1. 运行相应的脚本
2. 处理数据
3. 将输出保存到工作区
4. 向你报告结果

### 命令行使用

你也可以直接运行脚本：

```bash
# 搜索并下载字幕
cd .claude/skills/bilibili-toolkit/scripts
python workflow.py "关键词" --max-videos 5

# 搜索视频
python bilibili_search.py "关键词"

# 下载单个视频字幕
python bilibili_downloader.py "BV号或URL"
```

## 常见问题排查

### Cookie 相关问题

**问题**：提示"无法获取视频信息"或"该视频没有字幕"

**解决方案**：

1. 验证 Cookie 是否有效：
   - 在浏览器中登录 bilibili.com
   - 重新获取 Cookie
   - 更新 `bilibili-workspace/bilibili_cookies.json`

2. 检查 Cookie 文件位置：
   ```bash
   ls -la bilibili-workspace/bilibili_cookies.json
   ```

3. 验证 JSON 格式是否正确：
   ```bash
   cat bilibili-workspace/bilibili_cookies.json
   ```
   确保是有效的 JSON 格式，不能有多余的逗号或引号错误

### API 限制问题

**问题**：收到 412 或 429 错误

**解决方案**：

- 脚本已内置自动重试机制
- 大批量请求之间等待几分钟
- 确保使用已登录账号的 Cookie
- 避免在短时间内发送过多请求

### 字幕不可用

**问题**：视频提示"该视频没有字幕"

**说明**：不是所有视频都有字幕。视频必须满足以下条件之一：

- ✅ UP主上传了中文字幕
- ✅ B站自动生成了AI字幕

**建议**：

- 搜索官方账号或大UP主的视频（更可能有字幕）
- 选择播放量高的热门视频
- 避免选择太新或太小众的视频

### Python 模块错误

**问题**：`ModuleNotFoundError`

**解决方案**：

```bash
cd .claude/skills/bilibili-toolkit
pip install -r requirements.txt
```

如果还是有问题，尝试：

```bash
pip install --upgrade requests urllib3
```

### 文件路径问题

**问题**：找不到输出文件

**说明**：所有输出文件现在保存在 `bilibili-workspace/` 目录中：

```bash
# 查看字幕文件
ls bilibili-workspace/subtitles/

# 查看报告
ls bilibili-workspace/reports/

# 查看生成的文章
ls bilibili-workspace/articles/
```

### Cookie 过期

**问题**：之前能用的 Cookie 现在不能用了

**解决方案**：

B 站的 Cookie 会定期过期。解决方法：

1. 重新登录 bilibili.com
2. 获取新的 Cookie
3. 更新配置文件
4. 建议定期更新（每1-2周）

## 更新技能

当有新版本发布时，更新方法：

```bash
cd .claude/skills/bilibili-toolkit
# 如果使用 git
git pull

# 或者重新下载技能文件
```

**重要**：你在 `bilibili-workspace/` 中的数据不会受影响！

## Cookie 安全提示

**重要提醒**：Cookie 就像你的账号密码，请妥善保管！

### 安全建议：

- ❌ **不要**将 `bilibili_cookies.json` 提交到 Git 仓库
- ❌ **不要**在公开场合分享你的 Cookie
- ❌ **不要**将 Cookie 发送给他人
- ✅ **定期**更新 Cookie（每1-2周）
- ✅ **确保** `.gitignore` 包含了工作区目录
- ✅ **注意** Cookie 存储在本地工作区，不会上传

### 如果 Cookie 泄露：

1. 立即在 B 站退出登录
2. 重新登录
3. 获取新的 Cookie
4. 更新配置文件

## 性能优化

### 批量处理建议

处理大量视频时：

1. **分批处理**：每次处理 10-20 个视频
2. **添加延迟**：在批次之间等待 2-5 分钟
3. **使用筛选**：优先下载播放量高的视频
4. **定时运行**：在网络空闲时运行大任务

### 网络问题

如果网络不稳定：

1. 脚本已内置重试机制
2. 失败的下载会自动重试
3. 可以多次运行脚本，已下载的会跳过

## 支持

遇到问题时的检查清单：

- [ ] Cookie 是否有效且未过期
- [ ] Python 依赖是否正确安装
- [ ] 网络连接是否正常
- [ ] B 站是否可以正常访问
- [ ] 文件路径是否正确（使用绝对路径或相对路径）
- [ ] JSON 配置文件格式是否正确

如果以上都正常但仍有问题：

1. 查看详细的错误信息
2. 检查是否是 B 站 API 临时问题
3. 尝试更新 Cookie
4. 尝试使用不同的视频进行测试

## 高级配置

### 自定义输出路径

你可以在调用脚本时指定输出路径：

```python
from scripts.workflow import BilibiliWorkflow

workflow = BilibiliWorkflow()
# 自定义报告输出路径
workflow.generate_report(output_dir="/自定义/路径/reports")
```

### 环境变量优先级

Cookie 加载优先级：

1. 工作区配置文件（最高优先级）
2. 环境变量
3. 技能目录配置文件（向后兼容）

### 调试模式

启用详细日志输出：

```bash
export DEBUG=1
python scripts/workflow.py "关键词"
```

## 许可和免责声明

- 本工具仅供学习和研究使用
- 请遵守 B 站的使用条款
- 尊重内容创作者的版权
- 下载的字幕仅供个人使用
- 不得用于商业用途

---

**配置完成后，enjoy！开始使用 Claude 探索 B 站的视频内容吧！**
